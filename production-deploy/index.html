<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(){try{var P=(window.UniversalLessonPlayer&&window.UniversalLessonPlayer.prototype)||null;if(P&&typeof P._makeInspectorsDraggable!=='function'){P._makeInspectorsDraggable=function(){};}window._mlEnsureDragShim=function(){try{var P2=(window.UniversalLessonPlayer&&window.UniversalLessonPlayer.prototype)||null;if(P2&&typeof P2._makeInspectorsDraggable!=='function'){P2._makeInspectorsDraggable=function(){};}}catch(e){}};}catch(e){}})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iLearn - Complete Learning Experience</title>
    <meta name="description" content="Personalized learning with Kelly and Ken - Complete lesson experience">
    <meta name="keywords" content="education, learning, personalized, lessons, avatars">
    
    <!-- Script tags for universal lesson player system -->
    <script src="complete-curriculum.js"></script>
    <script src="corrected-variant-generator-v2.js"></script>
    <script src="homegrown-tts-system.js"></script>
    <script src="/complete-lesson-player.js?v=20250810a"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: transparent;
            color: white;
            line-height: 1.6;
            /* Enhanced background system with slide-by-slide transitions */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
        }

        .lesson-player {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: transparent;
            overflow: hidden;
        }

        /* Avatar container system */
        .avatar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            transition: background-image 0.5s ease;
        }

        .avatar-container.ken-active {
            background-image: url('/lesson-player-deploy/assets/avatars/ken/ken_neutral_default.png');
        }

        .avatar-container.kelly-active {
            background-image: url('/lesson-player-deploy/assets/avatars/kelly/kelly_neutral_default.png');
        }

        /* Glass morphism overlay system with face-safe zone design */
        .lesson-info {
            position: absolute;
            top: 16%;
            left: 8%;
            max-width: 40%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 24px;
            z-index: 5;
            animation: fadeIn 0.3s ease;
            pointer-events: none;
        }

        .lesson-info .content {
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lesson-info h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .lesson-info p {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .start-lesson-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        /* Enhanced side navigation with glass morphism */
        .side-navigation {
            position: fixed;
            bottom: 120px;
            right: 40px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        /* Professional audio controls - lower right, face-safe zone */
        .audio-controls {
            position: fixed;
            bottom: 32px;
            right: 160px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            z-index: 30;
        }

        .audio-controls:hover {
            opacity: 1;
        }

        .audio-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .audio-controls button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .audio-controls input[type="range"] {
            width: 80px;
            accent-color: #007AFF;
        }

        .audio-controls select {
            background: transparent;
            color: white;
            border: none;
            font-size: 12px;
            outline: none;
        }

        /* Avatar Behavior Controls (Left Side) */
        .avatar-controls {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 30;
        }

        .primary-avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .secondary-avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Content Controls (Right Side) */
        .content-controls {
            position: fixed;
            bottom: 100px;
            right: 30px;
            flex-direction: column;
            gap: 12px;
            z-index: 30;
        }

        .content-controls.show {
            display: flex;
        }

        .nav-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            color: #333;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            gap: 2px;
            padding: 4px;
        }

        .nav-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        }

        /* Enhanced calendar overlay with glass morphism */
        .calendar-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            max-width: 400px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .calendar-day {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day.today {
            background: #007AFF;
            color: white;
        }

        .calendar-day.available {
            background: rgba(0, 122, 255, 0.6);
            color: white;
        }

        .calendar-day.available:hover {
            background: rgba(0, 122, 255, 0.8);
            transform: scale(1.1);
        }

        .calendar-day.unavailable {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        /* Enhanced variant controls overlay */
        .variant-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            max-width: 320px;
        }

        .variant-control {
            margin-bottom: 16px;
        }

        .variant-control label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .variant-control select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #333;
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .variant-control select:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        /* Tone controls overlay */
        .tone-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            max-width: 280px;
        }

        .tone-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tone-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tone-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .tone-btn.active {
            background: #007AFF;
            border-color: #007AFF;
        }

        /* Avatar controls overlay */
        .avatar-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            max-width: 200px;
        }

        .avatar-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .avatar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .avatar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .avatar-btn.active {
            background: #007AFF;
            border-color: #007AFF;
        }

        /* Language controls overlay */
        .language-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 50;
            animation: fadeIn 0.3s ease;
            max-width: 280px;
        }

        .language-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .lang-btn.active {
            background: #007AFF;
            border-color: #007AFF;
        }

        /* Age controls overlay */
        .age-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            z-index: 50;
            animation: fadeIn 0.3s ease;
            max-width: 280px;
        }

        .age-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .age-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .age-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .age-btn.active {
            background: #007AFF;
            border-color: #007AFF;
        }

        /* New lesson creator overlay */
        .new-lesson-overlay {
            position: fixed;
            top: 16%;
            right: 8%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 24px;
            z-index: 50;
            animation: fadeIn 0.3s ease;
            max-width: 320px;
        }

        .new-lesson-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .lesson-topic-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
        }

        .lesson-topic-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        .generate-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .generate-btn:hover {
            background: #0056CC;
            transform: scale(1.02);
        }

        .generation-status {
            font-size: 12px;
            color: #666;
            text-align: center;
            min-height: 20px;
        }

        .nav-icon.active {
            background: #007AFF;
        }

        /* Dynamic Calendar Icon */
        #calendar-icon {
            position: relative;
        }

        .calendar-emoji {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
        }

        .calendar-date {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        /* Lesson content overlay - Clean, minimal design */
        .lesson-content-overlay {
            position: fixed;
            top: 20%;
            left: 20%;
            right: 20%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            padding: 24px;
            z-index: 50;
            animation: fadeIn 0.3s ease;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .lesson-content-overlay h3 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .lesson-content-overlay p {
            color: #666;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        /* Close button for overlays */
        .close-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .close-overlay:hover {
            opacity: 1;
        }

        /* Natural Human Controls - Final Media Player Replacement */
        .human-controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 30;
            opacity: 0.2;
            transition: all 0.3s ease;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .human-controls:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-50%) scale(1.02);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 4px;
        }

        /* Primary controls (Hold) - Largest */
        .control-btn.primary {
            width: 70px;
            height: 70px;
            font-size: 24px;
        }

        .control-btn.primary .icon-emoji {
            font-size: 24px;
        }

        .control-btn.primary .icon-label {
            font-size: 10px;
        }

        /* Secondary controls container */
        .secondary-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Menu button styling */
        .control-btn.menu-btn {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 122, 255, 0.3);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 122, 255, 0.3);
        }

        .control-btn:active {
            transform: scale(0.9);
            transition: all 0.1s ease;
        }

        .control-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }

        /* Always-visible labels inside icons */
        .control-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .control-btn .icon-emoji {
            font-size: 18px;
        }

        .control-btn .icon-label {
            font-size: 8px;
            color: #666;
            font-weight: 500;
            text-align: center;
            line-height: 1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Always-visible labels for navigation icons */
        .nav-icon {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .nav-icon .icon-emoji {
            font-size: 18px;
        }

        .nav-icon .icon-label {
            font-size: 8px;
            color: #666;
            font-weight: 500;
            text-align: center;
            line-height: 1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-button:hover {
            transform: scale(1.1);
            background: #0056CC;
        }

        /* Ask Interface Styles */
        .ask-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .ask-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ask-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 122, 255, 0.2);
        }

        .ask-header h3 {
            margin: 0;
            color: #007AFF;
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .ask-options {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .ask-option {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(0, 122, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .ask-option:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: rgba(0, 122, 255, 0.5);
            transform: translateY(-2px);
        }

        .ask-icon {
            font-size: 32px;
        }

        .ask-label {
            font-size: 16px;
            font-weight: 600;
            color: #007AFF;
            text-align: center;
        }

        .ask-resources {
            background: rgba(0, 122, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }

        .ask-resources h4 {
            margin: 0 0 15px 0;
            color: #007AFF;
            font-size: 18px;
            font-weight: 600;
        }

        .resource-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resource-item:hover {
            background: rgba(0, 122, 255, 0.1);
            transform: translateX(5px);
        }

        .resource-icon {
            font-size: 20px;
        }

        .resource-text {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .text-input-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0, 122, 255, 0.3);
            border-radius: 15px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .question-textarea:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .input-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .submit-btn, .cancel-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn {
            background: #007AFF;
            color: white;
        }

        .submit-btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #666;
        }

        .cancel-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            color: #333;
        }

        /* Phase 1 Controls (Only Two Icons) */
        .phase1-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            pointer-events: none;
        }

        .hold-button,
        .menu-button {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            color: #333;
            font-size: 20px;
            gap: 2px;
        }

        .hold-button {
            bottom: 30px;
            left: 30px;
        }

        .menu-button {
            bottom: 30px;
            right: 30px;
        }

        .hold-button:hover,
        .menu-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        }

        .hold-icon,
        .menu-icon {
            font-size: 20px;
            color: #333;
        }

        .hold-label {
            font-size: 10px;
            font-weight: 500;
            color: #666;
            text-align: center;
            line-height: 1;
        }



        .hold-icon,
        .menu-icon {
            font-size: 20px;
            color: #333;
        }

        /* Expanded Controls (Hidden by default) */
        .expanded-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            display: none !important;
            justify-content: space-between;
            align-items: flex-end;
            padding: 40px;
            flex-direction: row;
            box-sizing: border-box;
        }

        .expanded-controls.show {
            display: flex !important;
        }

        /* Avatar Controls (Left Side) */
        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            position: absolute;
            left: 40px;
            bottom: 40px;
        }

        /* Content Controls (Right Side) */
        .content-controls-expanded {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            position: absolute;
            right: 40px;
            bottom: 40px;
        }

        /* All nav-icons in expanded controls should be same size */
        .expanded-controls .nav-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            color: #333;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            gap: 2px;
            padding: 4px;
            margin: 0;
            flex-shrink: 0;
        }

        .expanded-controls .nav-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        }

        .expanded-controls .icon-emoji {
            font-size: 20px;
        }

        .expanded-controls .icon-label {
            font-size: 10px;
            font-weight: 500;
            color: #666;
            text-align: center;
            line-height: 1;
        }

        /* Hide Phase 1 controls when expanded */
        .expanded-controls.show ~ .phase1-controls {
            display: none;
        }

        /* Collapsed Controls */
        .collapsed-avatar-controls, .collapsed-content-controls {
            position: fixed;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 25;
        }

        .collapsed-avatar-controls {
            bottom: 40px;
            left: 20px;
        }

        .collapsed-content-controls {
            bottom: 40px;
            right: 20px;
        }

        .collapsed-icon {
            font-size: 20px;
            color: #666;
        }

        .collapsed-avatar-controls:hover, .collapsed-content-controls:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Hide controls when collapsed */
        .avatar-controls.collapsed, .content-controls.collapsed {
            display: none;
        }

        /* Show collapsed controls when main controls are hidden */
        .avatar-controls:not(.collapsed) ~ .collapsed-avatar-controls,
        .content-controls:not(.collapsed) ~ .collapsed-content-controls {
            display: none;
        }

        .speed-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .autoplay-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
        }

        .autoplay-toggle input[type="checkbox"] {
            accent-color: #007AFF;
        }

        /* AI Generation Styles */
        .ai-generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
            width: 100%;
        }

        .ai-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .ai-generate-btn:active {
            transform: translateY(0);
        }

        .lesson-opening {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .lesson-questions {
            margin: 20px 0;
        }

        .question-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .question-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .question-item ul {
            margin-top: 8px;
            padding-left: 20px;
        }

        .question-item li {
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.8);
        }

        .ai-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* Face-Safe Overlay Styles - FORCE ENFORCEMENT */
        .new-lesson-overlay,
        .calendar-overlay,
        .tone-overlay,
        .avatar-overlay,
        .language-overlay,
        .age-overlay {
            position: fixed !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
            padding: 24px !important;
            max-width: 350px !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            color: #333 !important;
            display: none !important;
        }

        /* CRITICAL: Force all overlays to start hidden */
        #new-lesson-overlay,
        #calendar-overlay,
        #tone-overlay,
        #avatar-overlay,
        #language-overlay,
        #age-overlay {
            display: none !important;
        }

        /* Force single overlay visibility */
        .overlay-active {
            display: block !important;
        }

        .overlay-hidden {
            display: none !important;
        }

        /* Face-safe positioning zones */
        .overlay-zone-topLeft {
            top: 50px !important;
            left: 50px !important;
        }

        .overlay-zone-topRight {
            top: 50px !important;
            right: 50px !important;
        }

        .overlay-zone-bottomLeft {
            bottom: 150px !important;
            left: 50px !important;
        }

        .overlay-zone-bottomRight {
            bottom: 150px !important;
            right: 50px !important;
        }

        /* Ensure lesson info doesn't cover face */
        .lesson-info {
            left: 50px !important;
            top: 50px !important;
            max-width: 300px !important;
            z-index: 5 !important;
        }

        /* Icon stack positioning */
        .side-navigation {
            bottom: 100px !important;
            right: 50px !important;
            z-index: 100 !important;
        }

        .new-lesson-overlay h3 {
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .new-lesson-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .lesson-topic-input {
            padding: 12px 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .lesson-topic-input:focus {
            border-color: #007AFF;
        }

        .generate-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            background: #0056CC;
            transform: translateY(-2px);
        }

        .generation-status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            min-height: 20px;
        }

        .generation-status.success {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .generation-status.error {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .generation-status.loading {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        /* Enhanced lesson content display */
        .lesson-content {
            position: absolute;
            top: 16%;
            left: 8%;
            max-width: 45%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 24px;
            z-index: 10;
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .lesson-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .lesson-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .content-text {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            margin-bottom: 16px;
        }

        .question-container {
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 122, 255, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: #007AFF;
            transform: translateY(-2px);
        }

        .choice-btn.selected {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        .feedback-text {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            padding: 12px;
            margin-top: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #2E7D32;
        }

        /* Content type specific styling */
        .introduction-content .content-text {
            color: #1976D2;
            font-weight: 500;
        }

        .main_content-content .content-text {
            color: #333;
        }

        .question-content .content-text {
            color: #D32F2F;
        }

        .conclusion-content .content-text {
            color: #388E3C;
            font-style: italic;
        }

        .completion-content .content-text {
            color: #FF6F00;
            font-weight: 600;
        }

        .fortune-content .content-text {
            color: #7B1FA2;
            font-style: italic;
        }

        /* Animation for content transitions */
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-content.active {
            animation: slideInFromBottom 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="lesson-player">
        <!-- Avatar container with initial Kelly avatar -->
        <div id="avatar-container" class="avatar-container kelly-active"></div>
        
        <!-- Lesson info overlay (left side) -->
        <div class="lesson-info">
            <div class="content">
                <h2 id="lesson-info-title">Loading today's lesson...</h2>
                <p id="lesson-info-objective">Please wait while we load your personalized lesson.</p>
            </div>
        </div>

        <!-- Lesson content overlay (center) - Clean, minimal design -->
        <div id="lesson-content-overlay" class="lesson-content-overlay" style="display: none;">
            <div id="lesson-content">
                <div id="lesson-text" class="lesson-text">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Content Controls (Right Side) - Hidden in Phase 1 -->
        <div class="content-controls" style="display: none !important;">
            <div class="nav-icon" id="calendar-icon" onclick="toggleCalendar()" data-label="Calendar">
                <div class="icon-emoji">üìÖ</div>
                <div class="icon-label" data-en="Calendar" data-es="Calendario" data-fr="Calendrier" data-de="Kalender" data-zh="Êó•ÂéÜ" data-ja="„Ç´„É¨„É≥„ÉÄ„Éº">Calendar</div>
                <div class="calendar-date">1</div>
            </div>
            <div class="nav-icon" onclick="toggleTone()" data-label="Tone">
                <div class="icon-emoji">üòä</div>
                <div class="icon-label" data-en="Tone" data-es="Tono" data-fr="Ton" data-de="Ton" data-zh="ËØ≠Ë∞É" data-ja="„Éà„Éº„É≥">Tone</div>
            </div>
            <div class="nav-icon" onclick="toggleAvatar()" data-label="Avatar">
                <div class="icon-emoji">üé≠</div>
                <div class="icon-label" data-en="Avatar" data-es="Avatar" data-fr="Avatar" data-de="Avatar" data-zh="Â§¥ÂÉè" data-ja="„Ç¢„Éê„Çø„Éº">Avatar</div>
            </div>
            <div class="nav-icon" onclick="toggleLanguage()" data-label="Language">
                <div class="icon-emoji">üåç</div>
                <div class="icon-label" data-en="Language" data-es="Idioma" data-fr="Langue" data-de="Sprache" data-zh="ËØ≠Ë®Ä" data-ja="Ë®ÄË™û">Language</div>
            </div>
            <div class="nav-icon" onclick="toggleAge()" data-label="Age">
                <div class="icon-emoji">üë∂</div>
                <div class="icon-label" data-en="Age" data-es="Edad" data-fr="√Çge" data-de="Alter" data-zh="Âπ¥ÈæÑ" data-ja="Âπ¥ÈΩ¢">Age</div>
            </div>
            <div class="nav-icon" onclick="openNewLessonCreator()" data-label="Create">
                <div class="icon-emoji" style="color: #28a745;">‚ûï</div>
                <div class="icon-label" data-en="Create" data-es="Crear" data-fr="Cr√©er" data-de="Erstellen" data-zh="ÂàõÂª∫" data-ja="‰ΩúÊàê">Create</div>
            </div>
        </div>





        <!-- Phase 1 Controls (Only Two Icons) -->
        <div class="phase1-controls">
            <!-- Hold Button (Bottom Left) -->
            <div class="hold-button" title="Hold">
                <div class="hold-icon">‚úã</div>
                <div class="hold-label">Hold</div>
            </div>
            
            <!-- Menu Button (Bottom Right) -->
            <div class="menu-button" title="Menu">
                <div class="menu-icon">‚ò∞</div>
            </div>
        </div>

        <!-- Expanded Controls (Hidden by default) -->
        <div class="expanded-controls" style="display: none !important;">
            <!-- Left Side: Avatar Behavior Controls -->
            <div class="avatar-controls">
                <div class="nav-icon" onclick="tellAvatar('continue')" data-label="Continue">
                    <div class="icon-emoji">üó£Ô∏è</div>
                    <div class="icon-label">Continue</div>
                </div>
                <div class="nav-icon" onclick="tellAvatar('louder')" data-label="Louder">
                    <div class="icon-emoji">üîä</div>
                    <div class="icon-label">Louder</div>
                </div>
                <div class="nav-icon" onclick="tellAvatar('quieter')" data-label="Softer">
                    <div class="icon-emoji">üîá</div>
                    <div class="icon-label">Softer</div>
                </div>
                <div class="nav-icon" onclick="tellAvatar('slower')" data-label="Slower">
                    <div class="icon-emoji">üêå</div>
                    <div class="icon-label">Slower</div>
                </div>
                <div class="nav-icon" onclick="tellAvatar('faster')" data-label="Faster">
                    <div class="icon-emoji">‚ö°</div>
                    <div class="icon-label">Faster</div>
                </div>
                <div class="nav-icon" onclick="tellAvatar('repeat')" data-label="Repeat">
                    <div class="icon-emoji">üîÑ</div>
                    <div class="icon-label">Repeat</div>
                </div>
            </div>
            
            <!-- Right Side: Content Controls -->
            <div class="content-controls-expanded">
                <div class="nav-icon" id="calendar-icon" onclick="toggleCalendar()" data-label="Calendar">
                    <div class="icon-emoji">üìÖ</div>
                    <div class="icon-label">Calendar</div>
                    <div class="calendar-date">1</div>
                </div>
                <div class="nav-icon" onclick="toggleTone()" data-label="Tone">
                    <div class="icon-emoji">üòä</div>
                    <div class="icon-label">Tone</div>
                </div>
                <div class="nav-icon" onclick="toggleAvatar()" data-label="Avatar">
                    <div class="icon-emoji">üé≠</div>
                    <div class="icon-label">Avatar</div>
                </div>
                <div class="nav-icon" onclick="toggleLanguage()" data-label="Language">
                    <div class="icon-emoji">üåç</div>
                    <div class="icon-label">Language</div>
                </div>
                <div class="nav-icon" onclick="toggleAge()" data-label="Age">
                    <div class="icon-emoji">üë∂</div>
                    <div class="icon-label">Age</div>
                </div>
                <div class="nav-icon" onclick="openNewLessonCreator()" data-label="Create">
                    <div class="icon-emoji" style="color: #28a745;">‚ûï</div>
                    <div class="icon-label">Create</div>
                </div>
            </div>
        </div>

        <!-- Calendar overlay -->
        <div id="calendar-overlay" class="calendar-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeCalendar()">√ó</button>
            <h3>üìÖ Lesson Calendar</h3>
            <p>Select a day to load a lesson:</p>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar days will be generated here -->
            </div>
        </div>

        <!-- Tone controls overlay -->
        <div id="tone-overlay" class="tone-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeTone()">√ó</button>
            <h3>üòä Tone Selection</h3>
            <div class="tone-options">
                <button class="tone-btn" onclick="setTone('neutral')">Neutral</button>
                <button class="tone-btn" onclick="setTone('fun')">Fun</button>
                <button class="tone-btn" onclick="setTone('grandparent')">Grandparent</button>
            </div>
        </div>

        <!-- Avatar controls overlay -->
        <div id="avatar-overlay" class="avatar-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeAvatar()">√ó</button>
            <h3>üé≠ Avatar Selection</h3>
            <div class="avatar-options">
                <button class="avatar-btn" onclick="setAvatar('ken')">Ken</button>
                <button class="avatar-btn" onclick="setAvatar('kelly')">Kelly</button>
                <button class="avatar-btn" onclick="setAvatar('you')">You</button>
            </div>
        </div>

        <!-- Language controls overlay -->
        <div id="language-overlay" class="language-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeLanguage()">√ó</button>
            <h3>üåç Language Selection</h3>
            <div class="language-options">
                <button class="lang-btn" onclick="setLanguage('english')">English</button>
                <button class="lang-btn" onclick="setLanguage('spanish')">Spanish</button>
                <button class="lang-btn" onclick="setLanguage('french')">French</button>
                <button class="lang-btn" onclick="setLanguage('german')">German</button>
                <button class="lang-btn" onclick="setLanguage('chinese')">Chinese</button>
                <button class="lang-btn" onclick="setLanguage('japanese')">Japanese</button>
            </div>
        </div>

        <!-- Age controls overlay -->
        <div id="age-overlay" class="age-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeAge()">√ó</button>
            <h3>üë∂ Age Group</h3>
            <div class="age-options">
                <button class="age-btn" onclick="setAge('age_2')">2 years (Toddler)</button>
                <button class="age-btn" onclick="setAge('age_5')">5 years (Early Childhood)</button>
                <button class="age-btn" onclick="setAge('age_8')">8 years (School Age)</button>
                <button class="age-btn" onclick="setAge('age_12')">12 years (Pre-Teen)</button>
                <button class="age-btn" onclick="setAge('age_16')">16 years (Teen)</button>
                <button class="age-btn" onclick="setAge('age_25')">25 years (Young Adult)</button>
                <button class="age-btn" onclick="setAge('age_40')">40 years (Midlife)</button>
                <button class="age-btn" onclick="setAge('age_60')">60 years (Mature Adult)</button>
                <button class="age-btn" onclick="setAge('age_80')">80 years (Elder)</button>
                <button class="age-btn" onclick="setAge('age_102')">102 years (Wisdom Years)</button>
            </div>
        </div>

        <!-- New lesson creator overlay -->
        <div id="new-lesson-overlay" class="new-lesson-overlay" style="display: none;">
            <button class="close-overlay" onclick="closeNewLesson()">√ó</button>
            <h3>üéØ Create New Universal Lesson</h3>
            
            <div class="create-interface">
                <div class="create-prompt">
                    <h4>"Type" or "Tell" me what you want to know</h4>
                    <p>I'll create a new universal lesson for us to talk about together.</p>
                    <p>Give me as much detail as you can.</p>
                </div>
                
                <div class="input-methods">
                    <button class="input-method" onclick="useVoiceInput()">
                        <div class="method-icon">üé§</div>
                        <div class="method-label">Tell Me</div>
                    </button>
                    <button class="input-method" onclick="useTextInput()">
                        <div class="method-icon">‚úèÔ∏è</div>
                        <div class="method-label">Type</div>
                    </button>
                </div>
                
                <div class="text-input-container" id="text-input-container" style="display: none;">
                    <textarea id="lesson-description" placeholder="Describe what you want to learn..." rows="4"></textarea>
                    <button onclick="calculateTokenCost()" class="calculate-btn">Calculate Cost</button>
                </div>
                
                <div class="token-calculation" id="token-calculation" style="display: none;">
                    <h4>Token Cost Analysis</h4>
                    <div id="cost-breakdown"></div>
                    <div class="payment-section">
                        <h4>Payment Method</h4>
                        <div id="stripe-payment-form"></div>
                    </div>
                </div>
                
                <div class="notification-preferences" id="notification-preferences" style="display: none;">
                    <h4>How would you like to be notified when your lesson is ready?</h4>
                    <div class="notification-options">
                        <button onclick="setNotification('email')">Email</button>
                        <button onclick="setNotification('sms')">SMS</button>
                        <button onclick="setNotification('push')">Push Notification</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variant control selects (hidden but accessible) -->
    <div style="display: none;">
        <select id="avatar-select">
            <option value="kelly">Kelly</option>
            <option value="ken">Ken</option>
        </select>
        <select id="tone-select">
            <option value="neutral">Neutral</option>
            <option value="fun">Fun</option>
            <option value="grandmother">Grandmother</option>
        </select>
        <select id="language-select">
            <option value="english">English</option>
            <option value="spanish">Spanish</option>
            <option value="french">French</option>
            <option value="german">German</option>
            <option value="chinese">Chinese</option>
            <option value="japanese">Japanese</option>
            <option value="portuguese">Portuguese</option>
            <option value="italian">Italian</option>
            <option value="russian">Russian</option>
            <option value="arabic">Arabic</option>
            <option value="hindi">Hindi</option>
            <option value="korean">Korean</option>
        </select>
        <select id="age-select">
            <option value="age_2">2 years (Toddler)</option>
            <option value="age_5">5 years (Early Childhood)</option>
            <option value="age_8">8 years (School Age)</option>
            <option value="age_12">12 years (Pre-Teen)</option>
            <option value="age_16">16 years (Teen)</option>
            <option value="age_25" selected>25 years (Young Adult)</option>
            <option value="age_40">40 years (Midlife)</option>
            <option value="age_60">60 years (Mature Adult)</option>
            <option value="age_80">80 years (Elder)</option>
            <option value="age_102">102 years (Wisdom Years)</option>
        </select>
    </div>

    <!-- Import complete systems -->
            
    
    <script>
        // Global variables for DNA-driven system
        let currentDNA = null;
        let currentAvatar = 'ken'; // Default to Ken
        let currentTone = 'neutral';
        let currentAge = 'adult'; // Default to adult
        let currentLanguage = 'english';
        let currentDay = 213; // Today: August 1st
        let isPlaying = false;
        let currentSpeed = 1.0;

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing iLearn How DNA-driven system...');
            
            // CRITICAL: Initialize face-safe system first
            if (window.faceSafeLayout) {
                console.log('üé≠ Initializing face-safe layout system...');
                window.faceSafeLayout.initializeFaceSafeSystem();
                
                // Force close all overlays initially
                const overlays = ['new-lesson-overlay', 'calendar-overlay', 'tone-overlay', 'avatar-overlay', 'language-overlay', 'age-overlay'];
                overlays.forEach(id => {
                    const overlay = document.getElementById(id);
                    if (overlay) {
                        overlay.style.display = 'none';
                        overlay.classList.add('overlay-hidden');
                        overlay.classList.remove('overlay-active');
                    }
                });
                console.log('‚úÖ Face-safe system initialized');
            }
            
            // Initialize avatar system with Kelly default
            initializeAvatarSystem();
            
            // Load today's lesson content - REMOVED: Now handled by Universal Lesson Player
            // loadTodaysLesson();
            
            // Initialize calendar - REMOVED: Now handled by Universal Lesson Player
            // initializeCalendar();
            
            // Initialize audio system
            initializeAudioSystem();
            
            console.log('‚úÖ DNA-driven system initialized successfully');
        });

        // Avatar system - Kelly default
        function initializeAvatarSystem() {
            console.log('üë§ Initializing avatar system with Kelly default...');
            const container = document.getElementById('avatar-container');
            if (container) {
                container.className = 'avatar-container ken-active';
                currentAvatar = 'ken';
                console.log('‚úÖ Avatar container initialized with Ken');
            } else {
                console.error('‚ùå Avatar container not found');
            }
        }

        function updateAvatarDisplay(avatar) {
            console.log(`üîÑ Switching to ${avatar} avatar...`);
            const container = document.getElementById('avatar-container');
            if (container) {
                container.classList.remove('ken-active', 'kelly-active');
                container.classList.add(`${avatar.toLowerCase()}-active`);
                currentAvatar = avatar;
                
                // Update lesson content based on avatar change
                if (currentDNA) {
                    regenerateLessonContent();
                }
                
                console.log(`‚úÖ Switched to ${avatar} avatar`);
            }
        }

        // DNA-driven lesson system
        async function loadDNAAndInitializeLesson() {
            console.log('üß¨ Loading DNA and initializing lesson...');
            
            try {
                // Load DNA file for current day
                const dnaData = await loadDNAForDay(currentDay);
                currentDNA = dnaData;
                
                // Generate initial lesson content
                regenerateLessonContent();
                
                console.log('‚úÖ DNA loaded and lesson initialized');
            } catch (error) {
                console.error('‚ùå Failed to load DNA:', error);
                // Fallback to default lesson
                displayDefaultLesson();
            }
        }

        async function loadDNAForDay(day) {
            // For now, use the dance expression DNA as example
            // In production, this would load the actual DNA file for the day
            const response = await fetch('/dna_files/001_dance_expression.json');
            return await response.json();
        }

        function regenerateLessonContent() {
            if (!currentDNA) return;
            
            console.log('üîÑ Regenerating lesson content with current settings...');
            
            // Get current user preferences
            const userPreferences = {
                age: currentAge,
                tone: currentTone,
                avatar: currentAvatar,
                language: currentLanguage
            };
            
            // Generate personalized content using DNA
            const lessonContent = generateLessonVariant(currentDNA, userPreferences);
            
            // Display the content
            displayLessonContent(lessonContent);
            
            // Update avatar mood based on DNA
            updateAvatarMood('opening', userPreferences);
        }

        function generateLessonVariant(dnaData, userPreferences) {
            console.log('üé® Generating lesson variant with DNA...');
            
            // Get age-specific content
            const ageData = dnaData.age_expressions[userPreferences.age] || dnaData.age_expressions.age_25;
            
            // Get tone-specific content
            const toneData = dnaData.tone_delivery_dna[userPreferences.tone] || dnaData.tone_delivery_dna.neutral;
            
            // Generate opening using DNA templates
            const opening = generateOpening(ageData, toneData, dnaData.learning_essence);
            
            // Generate questions using DNA structure
            const questions = generateQuestions(dnaData.core_lesson_structure, ageData, toneData);
            
            // Generate fortune using DNA elements
            const fortune = generateFortune(dnaData.daily_fortune_elements, userPreferences);
            
            return {
                opening,
                questions,
                fortune,
                topic: dnaData.universal_concept,
                objective: ageData.concept_name
            };
        }

        function generateOpening(ageData, toneData, learningEssence) {
            const openings = toneData.language_patterns.openings;
            const opening = openings[Math.floor(Math.random() * openings.length)];
            
            return `${opening} ${learningEssence}`;
        }

        function generateQuestions(lessonStructure, ageData, toneData) {
            const questions = [];
            
            // Generate 3 questions from DNA structure
            for (let i = 1; i <= 3; i++) {
                const questionData = lessonStructure[`question_${i}`];
                if (questionData) {
                    questions.push({
                        question: questionData.concept_focus,
                        optionA: questionData.choice_architecture.option_a,
                        optionB: questionData.choice_architecture.option_b
                    });
                }
            }
            
            return questions;
        }

        function generateFortune(fortuneElements, userPreferences) {
            const template = fortuneElements.fortune_template;
            const date = new Date().toLocaleDateString();
            
            return template
                .replace('{date}', date)
                .replace('{core_identity_shift}', fortuneElements.core_identity_shift)
                .replace('{relationship_impact}', fortuneElements.relationship_impact)
                .replace('{universal_connection}', fortuneElements.universal_connection);
        }

        function updateAvatarMood(section, userPreferences) {
            if (!currentDNA) return;
            
            const avatarSystem = currentDNA.__lesson_player_integration.ken_kelly_avatar_system;
            const moodTrigger = avatarSystem.mood_triggers[section];
            const expression = avatarSystem.expression_variations[userPreferences.tone];
            
            console.log(`üé≠ Updating avatar mood: ${expression} for ${moodTrigger}`);
            // In a full implementation, this would change avatar expressions
        }

        // Display lesson content in the UI
        function displayLessonContent(content) {
            console.log('üì∫ Displaying DNA-generated lesson content...');
            
            // Update lesson info overlay
            const lessonInfo = document.querySelector('.lesson-info .content');
            if (lessonInfo) {
                lessonInfo.innerHTML = `
                    <h2>${content.topic.replace(/_/g, ' ').toUpperCase()}</h2>
                    <p>${content.objective}</p>
                    <button class="start-lesson-btn" onclick="startLesson()">Start Lesson</button>
                `;
            }
            
            // Update lesson content overlay
            const lessonContent = document.getElementById('lesson-content');
            if (lessonContent) {
                lessonContent.innerHTML = `
                    <h3>Voice Over Script</h3>
                    <p>${content.opening}</p>
                    
                    <h3>On-Screen Text</h3>
                    <p>Today's Topic: ${content.topic.replace(/_/g, ' ').toUpperCase()}<br>
                    Objective: ${content.objective}</p>
                    
                    <h3>Lesson Approach</h3>
                    <p>We'll explore ${content.topic.replace(/_/g, ' ')} through interactive examples and real-world applications.</p>
                    
                    <h3>Daily Fortune</h3>
                    <p>${content.fortune}</p>
                `;
            }
        }

        // REMOVED: Old lesson functions - Now handled by Universal Lesson Player
        // function displayDefaultLesson() { ... }
        // function loadTodaysLesson() { ... }

        // Calendar system
        function initializeCalendar() {
            console.log('üìÖ Initializing calendar system...');
            generateCalendarGrid();
            updateCalendarDisplay();
        }

        function generateCalendarGrid() {
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) return;
            
            // Generate calendar for current month
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate();
                const isAvailable = day <= 366; // All days available for lessons
                const isSelected = day === currentDay;
                
                let className = 'calendar-day';
                if (isToday) className += ' today';
                else if (isAvailable) className += ' available';
                else className += ' unavailable';
                if (isSelected) className += ' selected';
                
                calendarHTML += `<button class="${className}" onclick="selectDay(${day})">${day}</button>`;
            }
            
            calendarGrid.innerHTML = calendarHTML;
        }

        function updateCalendarDisplay() {
            const calendarDate = document.querySelector('.calendar-date');
            if (calendarDate) {
                // Get current day of month
                const today = new Date();
                const currentDayOfMonth = today.getDate();
                calendarDate.textContent = currentDayOfMonth;
                console.log(`üìÖ Calendar updated to show day ${currentDayOfMonth}`);
            }
        }

        function selectDay(day) {
            console.log(`üìÖ Selected day ${day}`);
            currentDay = day;
            
            // Use new universal lesson player if available
            if (window.lessonPlayer) {
                console.log('‚úÖ Using Universal Lesson Player for day selection');
                window.lessonPlayer.selectDay(day);
            } else {
                console.warn('‚ö†Ô∏è Universal Lesson Player not available, using fallback');
                loadDNAAndInitializeLesson();
            }
            
            closeCalendar();
        }

        // Audio system
        function initializeAudioSystem() {
            console.log('üéµ Initializing audio system...');
            updateAudioControls();
        }

        function updateAudioControls() {
            const volumeSlider = document.getElementById('volume-slider');
            const speedSelect = document.getElementById('speed-select');
            const autoplayToggle = document.getElementById('autoplay-toggle');
            
            if (volumeSlider) volumeSlider.value = 80;
            if (speedSelect) speedSelect.value = currentSpeed;
            if (autoplayToggle) autoplayToggle.checked = true;
        }

        // PERFECT VARIANT CONTROL FUNCTIONS - IMMEDIATE TEXT CHANGES
        function toggleCalendar() {
            console.log('üìÖ Toggling calendar overlay...');
            const overlay = document.getElementById('calendar-overlay');
            if (overlay) {
                if (overlay.style.display === 'none' || !overlay.style.display) {
                    overlay.style.display = 'block';
                    // Generate calendar if not already done
                    if (!document.getElementById('calendar-grid').children.length) {
                        generateCalendar();
                    }
                } else {
                    overlay.style.display = 'none';
                }
            }
        }
        
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) return;
            
            calendarGrid.innerHTML = '';
            
            // Generate calendar for current month
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayButton = document.createElement('button');
                dayButton.className = 'calendar-day';
                dayButton.textContent = day;
                dayButton.onclick = () => selectDay(day);
                
                // Highlight today
                if (day === today.getDate()) {
                    dayButton.classList.add('today');
                }
                
                calendarGrid.appendChild(dayButton);
            }
        }

        function closeCalendar() {
            const overlay = document.getElementById('calendar-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function toggleVariants() {
            console.log('üìã Toggling variant controls...');
            showMessage('Use individual variant controls: üòä üé≠ üåç üë∂', 'info');
        }

        function toggleTone() {
            console.log('üòä Toggling tone controls...');
            const overlay = document.getElementById('tone-overlay');
            if (overlay) {
                const isVisible = overlay.style.display !== 'none';
                if (isVisible) {
                    overlay.style.display = 'none';
                    console.log('‚úÖ Tone overlay hidden');
                } else {
                    overlay.style.display = 'block';
                    console.log('‚úÖ Tone overlay shown');
                }
            } else {
                console.warn('‚ö†Ô∏è Tone overlay not found');
                showMessage('Tone options coming soon!', 'info');
            }
        }

        function closeTone() {
            const overlay = document.getElementById('tone-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function setTone(tone) {
            console.log(`üé≠ Setting tone to ${tone}`);
            currentTone = tone;
            
            // Update universal lesson player if available
            if (window.lessonPlayer) {
                window.lessonPlayer.onToneChange(tone);
                console.log('‚úÖ Tone updated in lesson player');
            } else {
                console.warn('‚ö†Ô∏è Lesson player not available for tone change');
            }
            
            closeTone();
            showMessage(`Tone changed to ${tone}`, 'success');
        }

        function toggleAvatar() {
            console.log('üé≠ Toggling avatar...');
            const overlay = document.getElementById('avatar-overlay');
            if (overlay) {
                const isVisible = overlay.style.display !== 'none';
                if (isVisible) {
                    overlay.style.display = 'none';
                    console.log('‚úÖ Avatar overlay hidden');
                } else {
                    overlay.style.display = 'block';
                    console.log('‚úÖ Avatar overlay shown');
                }
            } else {
                console.warn('‚ö†Ô∏è Avatar overlay not found');
                showMessage('Avatar options coming soon!', 'info');
            }
        }

        function closeAvatar() {
            const overlay = document.getElementById('avatar-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function setAvatar(avatar) {
            console.log(`üë§ Setting avatar to ${avatar}`);
            currentAvatar = avatar;
            
            // Update universal lesson player if available
            if (window.lessonPlayer) {
                window.lessonPlayer.onAvatarChange(avatar);
                console.log('‚úÖ Avatar updated in lesson player');
            } else {
                console.warn('‚ö†Ô∏è Lesson player not available for avatar change');
            }
            
            closeAvatar();
            showMessage(`Avatar changed to ${avatar}`, 'success');
        }

        function toggleLanguage() {
            console.log('üåç Toggling language...');
            const overlay = document.getElementById('language-overlay');
            if (overlay) {
                const isVisible = overlay.style.display !== 'none';
                if (isVisible) {
                    overlay.style.display = 'none';
                    console.log('‚úÖ Language overlay hidden');
                } else {
                    overlay.style.display = 'block';
                    console.log('‚úÖ Language overlay shown');
                }
            } else {
                console.warn('‚ö†Ô∏è Language overlay not found');
                showMessage('Language options coming soon!', 'info');
            }
        }

        function closeLanguage() {
            const overlay = document.getElementById('language-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function setLanguage(language) {
            console.log(`üåç Setting language to ${language}`);
            currentLanguage = language;
            
            // Update universal lesson player if available
            if (window.lessonPlayer) {
                window.lessonPlayer.onLanguageChange(language);
                console.log('‚úÖ Language updated in lesson player');
            } else {
                console.warn('‚ö†Ô∏è Lesson player not available for language change');
            }
            
            // Update all icon labels to match the new language
            updateIconLabels(language);
            
            closeLanguage();
            showMessage(`Language changed to ${language}`, 'success');
        }

        function updateIconLabels(language) {
            console.log(`üîÑ Updating icon labels to ${language}`);
            
            // Get all icon labels
            const iconLabels = document.querySelectorAll('.icon-label');
            
            iconLabels.forEach(label => {
                const newText = label.getAttribute(`data-${language}`);
                if (newText) {
                    label.textContent = newText;
                    console.log(`‚úÖ Updated label: ${label.textContent}`);
                } else {
                    console.warn(`‚ö†Ô∏è No translation found for ${language} in label`);
                }
            });
        }

        function showAskInterface() {
            console.log('‚ùì Showing ask interface...');
            
            // Create ask interface overlay
            const askOverlay = document.createElement('div');
            askOverlay.id = 'ask-overlay';
            askOverlay.className = 'ask-overlay';
            askOverlay.innerHTML = `
                <div class="ask-container">
                    <div class="ask-header">
                        <h3>Ask Your Teacher</h3>
                        <button class="close-btn" onclick="closeAskInterface()">√ó</button>
                    </div>
                    <div class="ask-content">
                        <div class="ask-options">
                            <button class="ask-option" onclick="askWithVoice()">
                                <div class="ask-icon">üé§</div>
                                <div class="ask-label">Voice Question</div>
                            </button>
                            <button class="ask-option" onclick="askWithText()">
                                <div class="ask-icon">‚úèÔ∏è</div>
                                <div class="ask-label">Type Question</div>
                            </button>
                        </div>
                        <div class="ask-resources">
                            <h4>Lesson Resources</h4>
                            <div class="resource-list">
                                <div class="resource-item">
                                    <span class="resource-icon">üìö</span>
                                    <span class="resource-text">Related Topics</span>
                                </div>
                                <div class="resource-item">
                                    <span class="resource-icon">üîó</span>
                                    <span class="resource-text">Additional Links</span>
                                </div>
                                <div class="resource-item">
                                    <span class="resource-icon">üìñ</span>
                                    <span class="resource-text">Deep Dive</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(askOverlay);
            
            // Auto-play "What would you like to know?"
            setTimeout(() => {
                avatarResponse('What would you like to know?');
            }, 500);
        }

        function closeAskInterface() {
            const askOverlay = document.getElementById('ask-overlay');
            if (askOverlay) {
                askOverlay.remove();
            }
            // Resume lesson
            if (window.lessonPlayer) {
                window.lessonPlayer.resumeLesson();
            }
        }

        function askWithVoice() {
            console.log('üé§ Voice question selected');
            avatarResponse('Voice input coming soon! For now, please type your question.');
            // TODO: Implement voice input with homegrown LLM
            showTextInput();
        }

        function askWithText() {
            console.log('‚úèÔ∏è Text question selected');
            showTextInput();
        }

        function showTextInput() {
            const askContent = document.querySelector('.ask-content');
            if (askContent) {
                askContent.innerHTML = `
                    <div class="text-input-container">
                        <textarea 
                            id="question-input" 
                            placeholder="Type your question here..."
                            rows="4"
                            class="question-textarea"
                        ></textarea>
                        <div class="input-buttons">
                            <button class="submit-btn" onclick="submitQuestion()">Ask Question</button>
                            <button class="cancel-btn" onclick="closeAskInterface()">Cancel</button>
                        </div>
                    </div>
                `;
                
                // Focus on textarea
                setTimeout(() => {
                    document.getElementById('question-input').focus();
                }, 100);
            }
        }

        function submitQuestion() {
            const question = document.getElementById('question-input').value.trim();
            if (question) {
                console.log('‚ùì Question submitted:', question);
                avatarResponse('Great question! This will connect to our knowledge base and homegrown LLM.');
                
                // TODO: Connect to knowledge base and homegrown LLM
                // TODO: Process question and provide intelligent response
                // TODO: Show relevant lesson resources
                
                setTimeout(() => {
                    closeAskInterface();
                }, 2000);
            } else {
                avatarResponse('Please type a question first.');
            }
        }

        function toggleAge() {
            console.log('üë∂ Toggling age controls...');
            const overlay = document.getElementById('age-overlay');
            if (overlay) {
                const isVisible = overlay.style.display !== 'none';
                if (isVisible) {
                    overlay.style.display = 'none';
                    console.log('‚úÖ Age overlay hidden');
                } else {
                    overlay.style.display = 'block';
                    console.log('‚úÖ Age overlay shown');
                }
            } else {
                console.warn('‚ö†Ô∏è Age overlay not found');
                showMessage('Age options coming soon!', 'info');
            }
        }

        function closeAge() {
            const overlay = document.getElementById('age-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function setAge(age) {
            console.log(`üë∂ Setting age to ${age}`);
            currentAge = age;
            
            // Update universal lesson player if available
            if (window.lessonPlayer) {
                window.lessonPlayer.onAgeChange(age);
                console.log('‚úÖ Age updated in lesson player');
            } else {
                console.warn('‚ö†Ô∏è Lesson player not available for age change');
            }
            
            closeAge();
            showMessage(`Age changed to ${age}`, 'success');
        }

        // Natural Human Control Functions - Final Media Player Replacement
        function tellAvatar(command) {
            console.log(`üó£Ô∏è Telling avatar: ${command}`);
            
            if (window.lessonPlayer) {
                switch(command) {
                    case 'continue':
                        window.lessonPlayer.resumeLesson();
                        avatarResponse('I\'m ready. Continue, please.');
                        // Collapse all controls when avatar starts talking
                        collapseAllControls();
                        break;
                    case 'ask':
                        window.lessonPlayer.pauseLesson();
                        avatarResponse('What would you like to know?');
                        showAskInterface();
                        break;
                    case 'hold':
                        window.lessonPlayer.pauseLesson();
                        avatarResponse('Holding here. Take your time.');
                        // Expand all controls when user interrupts
                        expandAllControls();
                        break;
                    case 'louder':
                        window.lessonPlayer.setVolume(Math.min(window.lessonPlayer.volume + 0.2, 1.0));
                        avatarResponse('Speaking louder now.');
                        break;
                    case 'quieter':
                        window.lessonPlayer.setVolume(Math.max(window.lessonPlayer.volume - 0.2, 0.0));
                        avatarResponse('Speaking softer now.');
                        break;
                    case 'slower':
                        window.lessonPlayer.setSpeed(Math.max(window.lessonPlayer.playbackSpeed - 0.2, 0.5));
                        avatarResponse('Speaking slower now.');
                        break;
                    case 'faster':
                        window.lessonPlayer.setSpeed(Math.min(window.lessonPlayer.playbackSpeed + 0.2, 2.0));
                        avatarResponse('Speaking faster now.');
                        break;
                    case 'repeat':
                        window.lessonPlayer.repeatCurrentPhase();
                        avatarResponse('Repeating that for you.');
                        break;
                    default:
                        console.warn(`Unknown command: ${command}`);
                        avatarResponse(`I don't understand "${command}". Try: talk, hold, louder, quieter, slower, faster, or repeat.`);
                }
            } else {
                console.warn('‚ö†Ô∏è Lesson player not available for avatar commands');
                avatarResponse('Sorry, I\'m not ready to respond yet. Please wait a moment.');
            }
        }

        function avatarResponse(message) {
            console.log(`üë§ Avatar response: ${message}`);
            
            // Remove any existing response
            const existingResponse = document.querySelector('.avatar-response');
            if (existingResponse) {
                existingResponse.remove();
            }
            
            // Visual response - show brief text feedback
            const responseDiv = document.createElement('div');
            responseDiv.className = 'avatar-response';
            responseDiv.textContent = message;
            responseDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 500;
                z-index: 1000;
                animation: fadeInOut 2.5s ease;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            `;
            
            document.body.appendChild(responseDiv);
            
            // Remove after animation
            setTimeout(() => {
                if (responseDiv.parentNode) {
                    responseDiv.parentNode.removeChild(responseDiv);
                }
            }, 2500);
            
            // Add CSS animation if not already present
            if (!document.getElementById('avatar-response-styles')) {
                const style = document.createElement('style');
                style.id = 'avatar-response-styles';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                        15% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
                        85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function toggleAvatarControls() {
            console.log('‚úã Toggling avatar controls...');
            
            const avatarControls = document.querySelector('.avatar-controls');
            const secondaryAvatarControls = document.querySelector('.secondary-avatar-controls');
            
            if (avatarControls && secondaryAvatarControls) {
                const isExpanded = !avatarControls.classList.contains('collapsed');
                
                if (isExpanded) {
                    // Collapse - hide all avatar controls
                    avatarControls.classList.add('collapsed');
                    secondaryAvatarControls.style.display = 'none';
                    console.log('‚úÖ Avatar controls collapsed');
                } else {
                    // Expand - show all avatar controls
                    avatarControls.classList.remove('collapsed');
                    secondaryAvatarControls.style.display = 'flex';
                    console.log('‚úÖ Avatar controls expanded');
                }
            } else {
                console.warn('‚ö†Ô∏è Avatar controls not found');
            }
        }

        function collapseAllControls() {
            console.log('üîΩ Collapsing all controls...');
            const expandedControls = document.querySelector('.expanded-controls');
            const contentControls = document.querySelector('.content-controls');
            
            if (expandedControls) expandedControls.style.display = 'none';
            if (contentControls) contentControls.classList.remove('show');
            console.log('‚úÖ All controls collapsed');
        }

        function expandAllControls() {
            console.log('üîº Expanding all controls...');
            const expandedControls = document.querySelector('.expanded-controls');
            const contentControls = document.querySelector('.content-controls');
            
            if (expandedControls) expandedControls.style.display = 'block';
            if (contentControls) contentControls.classList.add('show');
            console.log('‚úÖ All controls expanded');
        }

        function toggleAllControls() {
            console.log('‚ò∞ Toggling all controls...');
            const expandedControls = document.querySelector('.expanded-controls');
            
            if (expandedControls) {
                const isVisible = expandedControls.classList.contains('show');
                console.log('Current visibility:', isVisible);
                console.log('Current display style:', expandedControls.style.display);
                console.log('Current classes:', expandedControls.className);
                
                if (isVisible) {
                    // Collapse - hide all controls
                    expandedControls.classList.remove('show');
                    expandedControls.style.display = 'none';
                    console.log('‚úÖ All controls collapsed');
                } else {
                    // Expand - show all controls (left and right)
                    expandedControls.classList.add('show');
                    expandedControls.style.display = 'flex';
                    console.log('‚úÖ All controls expanded');
                    console.log('New classes:', expandedControls.className);
                    console.log('New display style:', expandedControls.style.display);
                    
                    // Controls expanded successfully
                }
            } else {
                console.warn('‚ö†Ô∏è Expanded controls not found');
            }
        }

        // Make function globally accessible
        window.toggleAllControls = toggleAllControls;

        // Lesson control functions
        function startLesson() {
            console.log('üöÄ Starting universal lesson...');
            
            // Use universal lesson player if available
            if (window.lessonPlayer) {
                console.log('‚úÖ Using Universal Lesson Player');
                window.lessonPlayer.startUniversalLesson();
            } else {
                console.warn('‚ö†Ô∏è Universal Lesson Player not available, using fallback');
                // Fallback to old method
                const lessonContentOverlay = document.getElementById('lesson-content-overlay');
                if (lessonContentOverlay) {
                    lessonContentOverlay.style.display = 'block';
                }
            }
        }

        function closeLessonContent() {
            const overlay = document.getElementById('lesson-content-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Utility functions
        function showMessage(message, type = 'info') {
            console.log(`üí¨ ${message}`);
            // Simple message display - could be enhanced with toast notifications
        }

        // Enhanced Create System Functions
        function useVoiceInput() {
            console.log('üé§ Voice input selected');
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    showMessage('Listening... Speak now.', 'info');
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('lesson-description').value = transcript;
                    calculateTokenCost();
                };
                
                recognition.onerror = (event) => {
                    showMessage('Voice input failed. Please try typing instead.', 'error');
                };
                
                recognition.start();
            } else {
                showMessage('Voice input not supported. Please use text input.', 'error');
                useTextInput();
            }
        }

        function useTextInput() {
            console.log('‚úèÔ∏è Text input selected');
            document.getElementById('text-input-container').style.display = 'block';
            document.getElementById('lesson-description').focus();
        }

        function calculateTokenCost() {
            const description = document.getElementById('lesson-description').value;
            if (!description.trim()) {
                showMessage('Please enter a lesson description first.', 'error');
                return;
            }
            
            // Estimate token count (rough calculation)
            const wordCount = description.split(' ').length;
            const estimatedTokens = Math.ceil(wordCount * 1.3); // Rough estimate
            const cost = (estimatedTokens * 0.0001).toFixed(2); // $0.0001 per token
            
            document.getElementById('cost-breakdown').innerHTML = `
                <p><strong>Estimated tokens:</strong> ${estimatedTokens.toLocaleString()}</p>
                <p><strong>Estimated cost:</strong> $${cost}</p>
                <p><em>This will generate a complete universal lesson with all variants.</em></p>
            `;
            
            document.getElementById('token-calculation').style.display = 'block';
            initializeStripePayment(parseFloat(cost));
        }

        function initializeStripePayment(cost) {
            // Placeholder for Stripe integration
            const paymentForm = document.getElementById('stripe-payment-form');
            paymentForm.innerHTML = `
                <div class="payment-placeholder">
                    <p>Payment integration coming soon!</p>
                    <p>Estimated cost: $${cost}</p>
                    <button onclick="processPayment(${cost})" class="payment-btn">Process Payment</button>
                </div>
            `;
        }

        function processPayment(cost) {
            showMessage('Payment processed! Generating your lesson...', 'success');
            
            // Simulate lesson generation
            setTimeout(() => {
                showNotificationPreferences();
            }, 2000);
        }

        function showNotificationPreferences() {
            document.getElementById('token-calculation').style.display = 'none';
            document.getElementById('notification-preferences').style.display = 'block';
        }

        function setNotification(type) {
            showMessage(`Notification preference set to ${type}. You'll be notified when your lesson is ready!`, 'success');
            setTimeout(() => {
                closeNewLesson();
            }, 2000);
        }

        // Initialize systems on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing iLearn How systems...');
            
            // Update lesson info immediately
            const lessonInfoTitle = document.getElementById('lesson-info-title');
            const lessonInfoObjective = document.getElementById('lesson-info-objective');
            if (lessonInfoTitle && lessonInfoObjective) {
                lessonInfoTitle.textContent = 'Sustainable Innovation - Creating Without Destroying';
                lessonInfoObjective.textContent = 'Practice sustainable design thinking while understanding how environmental considerations must guide technological development and economic systems.';
                console.log('‚úÖ Lesson info updated for day 214');
            } else {
                console.error('‚ùå Lesson info elements not found');
            }
            
            // Initialize universal lesson player FIRST
            if (typeof UniversalLessonPlayer !== 'undefined') {
                window.lessonPlayer = new UniversalLessonPlayer();
                console.log('‚úÖ Universal Lesson Player initialized');
                
                // Wait for lesson player to load curriculum, then update display
                setTimeout(() => {
                    // Then try lesson player if available
                    if (window.lessonPlayer && window.lessonPlayer.loadCurrentLesson) {
                        window.lessonPlayer.loadCurrentLesson();
                        console.log('‚úÖ Current lesson loaded');
                    }
                    
                    updateCalendarDisplay();
                    initializeAudioSystem();
                }, 1000);
            } else {
                console.warn('‚ö†Ô∏è UniversalLessonPlayer not available');
                // Fallback to old system
                initializeAudioSystem();
                updateCalendarDisplay();
            }
        });

        // Add proper event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Setting up event listeners...');
            
            // Add direct event listeners to buttons
            const holdButton = document.querySelector('.hold-button');
            const menuButton = document.querySelector('.menu-button');
            
            if (holdButton) {
                // Remove existing onclick and add new event listener
                holdButton.removeAttribute('onclick');
                holdButton.addEventListener('click', function(e) {
                    console.log('‚úã Hold button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAllControls();
                });
                console.log('‚úÖ Hold button event listener added');
            } else {
                console.warn('‚ö†Ô∏è Hold button not found');
            }
            
            if (menuButton) {
                // Remove existing onclick and add new event listener
                menuButton.removeAttribute('onclick');
                menuButton.addEventListener('click', function(e) {
                    console.log('‚ò∞ Menu button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAllControls();
                });
                console.log('‚úÖ Menu button event listener added');
            } else {
                console.warn('‚ö†Ô∏è Menu button not found');
            }
            
            // Hide content controls by default in Phase 1
            const contentControls = document.querySelector('.content-controls');
            if (contentControls) {
                contentControls.style.display = 'none';
                console.log('‚úÖ Content controls hidden in Phase 1');
            }
            
            console.log('‚úÖ Event listeners setup complete');
        });
    </script>
</body>
</html>